#!/bin/bash

#Obtain current directory
export SITC_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
export SITC_LOG="$SITC_ROOT/sitc.log"
source $SITC_ROOT/install.conf
source $SITC_ROOT/util

for param in $@; do
	# Potentially override defaults in install.conf
	if [ "`echo $param | cut -c1-2`" == "--" ]; then
		export "`echo $param | cut -c3-`"
		paramname=`echo $param | cut -c3- | cut -d "=" -f1`
		if [ "$paramname" == "help" ]; then
			printHelp
			quit
		fi
		sed -i "s&export $paramname=.*&export $paramname=\"${!paramname}\"&" $SITC_ROOT/install.conf
	elif [ "`echo $param | cut -c1-1`" == "-" ]; then
		param="`echo $param | cut -c2-`" # remove the '-'
		for var in `echo "$param" | sed -e 's/\(.\)/\1\n/g'`; do
			case $var in
				"y") YES_TO_ALL=true ;;
				"v") cat $SITC_ROOT/version && exit ;;
				"h") printHelp ;;
			esac
		done
	fi
done

echo
echo "Server In The Cloud version `cat $SITC_ROOT/version`"
echo "Copyright (c) 2016, WebMO, LLC, all rights reserved."

if [ ! -e $SITC_ROOT/license_agreed ] && [ "$YES_TO_ALL" == "false" ]; then
	echo
	echo "This script automates the installation of software from several"
	echo "third parties. Many of these have licenses that are agreed to"
	echo "automatically by this script. Indicate your consent by pressing"
	echo "ENTER, or press CTRL-c to exit."
	echo
	read ans
	touch $SITC_ROOT/license_agreed
fi

echo
echo "Sanity check! You have selected to do the following:"
summarizeSettings
echo "Press ENTER to continue, or CTRL-c to exit."
echo
read ans

if [ -n "`uname -a | grep -i Debian`" ]; then
   OS="debian"
elif [ -n "`uname -a | grep -i ubuntu`" ]; then
   OS="ubuntu"
elif [ -e "/etc/redhat-release" ]; then
   OS="centos"
else
   echo "Unidentified OS! Exiting."
   exit
fi

echo "Installing for $OS"
echo
echo "Logging script output to $SITC_LOG"

if [ ! -e $SITC_ROOT/ran_os_additions ]; then
	echo
	echo "*** RUNNING OS_ADDITIONS ***"
	$SITC_ROOT/scripts/$OS/os_additions
	if [ "$YES_TO_ALL" == "false" ]; then
		read -s -n 1 -p "Press any key to continue"
	fi
	touch $SITC_ROOT/ran_os_additions
fi

if [ "$SKIP_WEBMO" != "true" ]; then
	echo
	echo "*** RUNNING INSTALL_WEBMO ***"
	$SITC_ROOT/scripts/$OS/install_webmo $SITC_ROOT
	if [ "$YES_TO_ALL" == "false" ]; then
		read -s -n 1 -p "Press any key to continue"
	fi
fi

echo
echo "*** INSTALLING ENGINES ***"
for engine in `sed 's/,/ /g' <<< $ENGINES`; do
        echo "Installing $engine"
	if [ -e "$SITC_ROOT/scripts/$OS/install_$engine" ]; then
		# Distro specific installation instructions
	        $SITC_ROOT/scripts/$OS/install_$engine
	fi
	# Common insallation instructions
	$SITC_ROOT/scripts/common/install_$engine
	echo
done
if [ "$YES_TO_ALL" == "false" ]; then
        read -s -n 1 -p "Press any key to continue"
fi

if [ "$SKIP_WEBMO" != "true" ]; then
	echo
	echo "Enabling engines in WebMO"
	sudo $SITC_ROOT/scripts/common/enable_in_webmo $SITC_ROOT/engines.log /home/$WEBMO_USER/public_html/cgi-bin/webmo/interfaces

	#if [ ! -d /home/$WEBMO_USER/sitc ]; then
	#	echo "Copying scripts to /home/$WEBMO_USER/sitc"
	#	sudo cp -a $SITC_ROOT /home/$WEBMO_USER/sitc
	#	sudo chown -R $WEBMO_USER:$WEBMO_USER /home/$WEBMO_USER/sitc
	#fi

	IP=`curl -s "http://metadata/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip" -H "X-Google-Metadata-Request: True"`
	echo "

*** CONFIGURE INSTALLATION ***

In your web browser, login to $IP/$WEBMO_USER with the
username \"admin\" and a blank password. Set the admin password.

Run a test job."
fi
echo
